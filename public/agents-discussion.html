<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>üí¨ Agents ‚Äì Discussion Live</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='80'>ü§ñ</text></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?v=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-500: #667eea;
      --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --bg-primary: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
             --space-8: 2rem;
       --text-sm: 0.875rem;
       --text-base: 1rem;
       --text-lg: 1.125rem;
       --radius: 0.5rem;
       --radius-lg: 1rem;
       --radius-xl: 1.5rem;
       --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    .glass-panel {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.125);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .page-layout {
      display: grid;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 var(--space-6);
      gap: var(--space-8);
      grid-template-columns: 400px minmax(0, 1fr) 450px;
      min-height: calc(100vh - 120px);
    }

    .nav-sidebar {
      position: sticky;
      top: var(--space-4);
      align-self: start;
    }

    .main-content {
      min-height: 80vh;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
       gap: var(--space-2);
       padding: var(--space-4) var(--space-6);
      border: none;
       border-radius: var(--radius-lg);
       font-weight: 600;
       font-size: var(--text-sm);
      cursor: pointer;
       transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      position: relative;
      overflow: hidden;
       backdrop-filter: blur(20px);
       transform: translateY(0);
       box-shadow: 
         0 4px 16px rgba(0, 0, 0, 0.1),
         0 2px 8px rgba(0, 0, 0, 0.05);
       letter-spacing: 0.025em;
       min-height: 44px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
       background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
       transition: left 0.6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

     .btn:hover {
       transform: translateY(-3px) scale(1.02);
       box-shadow: 
         0 12px 32px rgba(0, 0, 0, 0.15),
         0 6px 16px rgba(0, 0, 0, 0.1);
     }

     .btn:active {
       transform: translateY(-1px) scale(0.98);
       transition: transform 0.1s ease;
     }
     
     .btn:focus {
       outline: 2px solid var(--primary-500);
       outline-offset: 2px;
       box-shadow: 
         0 0 0 4px rgba(102, 126, 234, 0.1),
         0 8px 25px rgba(0, 0, 0, 0.15);
     }

    .btn-primary {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
       border: 1px solid rgba(255, 255, 255, 0.2);
       box-shadow: 
         0 8px 25px rgba(102, 126, 234, 0.3),
         0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .btn-primary:hover {
       background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
       transform: translateY(-3px) scale(1.02);
       box-shadow: 
         0 15px 35px rgba(102, 126, 234, 0.4),
         0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
       background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
       border: 1px solid rgba(255, 255, 255, 0.2);
       box-shadow: 
         0 8px 25px rgba(240, 147, 251, 0.3),
         0 4px 12px rgba(245, 87, 108, 0.2);
    }

    .btn-secondary:hover {
       background: linear-gradient(135deg, #e91e63 0%, #f50057 100%);
       transform: translateY(-3px) scale(1.02);
       box-shadow: 
         0 15px 35px rgba(240, 147, 251, 0.4),
         0 8px 20px rgba(245, 87, 108, 0.3);
    }

    .btn-subtle {
       background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      color: var(--text-secondary);
       border: 1px solid rgba(255, 255, 255, 0.15);
       backdrop-filter: blur(10px);
    }

    .btn-subtle:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      color: var(--text-primary);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px) scale(1.02);
        box-shadow: 
          0 8px 20px rgba(255, 255, 255, 0.1),
          0 4px 12px rgba(255, 255, 255, 0.05);
      }

      /* Ensure hover effects work properly */
      .btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 
          0 12px 32px rgba(0, 0, 0, 0.15),
          0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 
          0 15px 35px rgba(102, 126, 234, 0.4),
          0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #e91e63 0%, #f50057 100%);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 
          0 15px 35px rgba(240, 147, 251, 0.4),
          0 8px 20px rgba(245, 87, 108, 0.3);
    }

    .prompt-input {
      flex: 1;
      padding: var(--space-4) var(--space-5);
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      color: #1f2937;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .prompt-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .chat-container {
      height: calc(70vh - var(--space-8));
      overflow: hidden;
    }

    .chat {
      height: 100%;
      overflow-y: auto;
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .bubble {
      max-width: 85%;
      padding: var(--space-6) var(--space-8);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .bubble.agent {
      align-self: flex-start;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(129, 140, 248, 0.1));
      border-left: 4px solid var(--primary-500);
    }

    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(20, 184, 166, 0.1));
      border-right: 4px solid #4facfe;
    }

    .bubble.system {
      align-self: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.05));
      border: 1px dashed rgba(255, 255, 255, 0.3);
      max-width: 70%;
    }

    .bubble-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .avatar {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 0.75rem;
      color: white;
      font-weight: 600;
    }

    .avatar.agent { background: var(--primary); }
    .avatar.user { background: var(--success); }
    .avatar.system { background: #f59e0b; }

    .phase-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--primary);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .code-output {
      margin-top: 1rem;
      max-height: 300px;
      overflow: auto;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: 'Inter', sans-serif;
      color: #e2e8f0;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .output-item {
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary-500);
      transition: all 0.3s ease;
    }

    .output-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .output-agent {
      font-weight: 600;
      color: #60a5fa;
    }

    .output-phase {
      padding: 0.2rem 0.5rem;
      background: var(--primary);
      color: white;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .output-content {
      color: var(--text-primary);
      line-height: 1.6;
      word-wrap: break-word;
    }

    .agent-chip {
      display: inline-flex;
      align-items: center;
       gap: 0.5rem;
       padding: 8px 16px;
      border-radius: 9999px;
       border: 1px solid rgba(255,255,255,0.15);
       background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      color: var(--text-secondary);
      cursor: pointer;
       transition: all 0.3s ease;
      user-select: none;
       backdrop-filter: blur(10px);
       font-weight: 500;
       font-size: 0.875rem;
       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
     }

     .agent-chip:hover {
       background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      color: var(--text-primary);
       transform: translateY(-2px);
       box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
       border-color: rgba(255, 255, 255, 0.25);
     }

     .agent-chip input.agent-checkbox {
       width: 16px;
       height: 16px;
       margin: 0;
     }

           .agent-chip.active {
        background: linear-gradient(135deg, rgba(102,126,234,0.25), rgba(102,126,234,0.15));
        border-color: rgba(102,126,234,0.6);
        color: var(--text-primary);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
      }

                                /* Tooltip Styles */
                   .agent-chip {
                     position: relative;
                   }
             
                   /* Tooltip styles for JavaScript-generated tooltips */
                   .tooltip {
                     position: fixed;
                     left: 50%;
                     top: 50%;
                     transform: translate(-50%, -50%);
                     padding: 20px 24px;
                     background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
                     backdrop-filter: blur(20px);
                     border: 2px solid rgba(102, 126, 234, 0.4);
                     border-radius: 16px;
                     color: #ffffff;
                     font-size: 0.9rem;
                     line-height: 1.6;
                     white-space: pre-line;
                     max-width: 400px;
                     min-width: 300px;
                     z-index: 999999;
                     box-shadow: 
                       0 25px 50px rgba(0, 0, 0, 0.5),
                       0 10px 20px rgba(0, 0, 0, 0.3),
                       0 0 0 1px rgba(255, 255, 255, 0.15);
                     animation: tooltipFadeIn 0.3s ease;
                     pointer-events: none;
                     font-weight: 500;
                     text-align: left;
                     word-wrap: break-word;
                     overflow-wrap: break-word;
                     font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                   }
             
                   /* Remove arrow for centered tooltip */
                   .agent-chip[data-tooltip]:hover::before {
                     display: none;
                   }
             
                   @keyframes tooltipFadeIn {
                     from {
                       opacity: 0;
                       transform: translateY(-50%) scale(0.95);
                     }
                     to {
                       opacity: 1;
                       transform: translateY(-50%) scale(1);
                     }
                   }
             
                   /* Responsive tooltip positioning */
                   @media (max-width: 1200px) {
                     .agent-chip[data-tooltip]:hover::after {
                       max-width: 80vw;
                       min-width: 280px;
                       font-size: 0.85rem;
                       padding: 18px 22px;
                     }
                   }
             
                   /* Mobile tooltip adjustments */
                   @media (max-width: 768px) {
                     .agent-chip[data-tooltip]:hover::after {
                       max-width: 95vw;
                       min-width: 280px;
                       font-size: 0.8rem;
                       padding: 16px 20px;
                       border-radius: 12px;
                     }
                   }

     .fab {
       position: fixed;
       bottom: 2rem;
       right: 2rem;
       width: 64px;
       height: 64px;
       border-radius: 50%;
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       border: 2px solid rgba(255, 255, 255, 0.2);
       cursor: pointer;
       box-shadow: 
         0 12px 40px rgba(102, 126, 234, 0.5),
         0 6px 20px rgba(102, 126, 234, 0.3);
       transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
       z-index: 50;
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 1.2rem;
       backdrop-filter: blur(20px);
     }

     .fab:hover {
       transform: translateY(-6px) scale(1.1);
       box-shadow: 
         0 20px 60px rgba(102, 126, 234, 0.7),
         0 10px 30px rgba(102, 126, 234, 0.5);
       border-color: rgba(255, 255, 255, 0.4);
     }

     .fab:active {
       transform: translateY(-3px) scale(0.95);
       transition: transform 0.1s ease;
     }

          .fab:focus {
       outline: 2px solid var(--primary-500);
       outline-offset: 2px;
       box-shadow: 
         0 0 0 4px rgba(102, 126, 234, 0.1),
         0 15px 45px rgba(102, 126, 234, 0.6);
     }

     /* Tooltip styles for JavaScript-generated tooltips */
     .tooltip {
       position: fixed;
       left: 50%;
       top: 50%;
       transform: translate(-50%, -50%);
       padding: 20px 24px;
       background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
       backdrop-filter: blur(20px);
       border: 2px solid rgba(102, 126, 234, 0.4);
       border-radius: 16px;
       color: #ffffff;
       font-size: 0.9rem;
       line-height: 1.6;
       white-space: pre-line;
       max-width: 400px;
       min-width: 300px;
       z-index: 999999;
       box-shadow: 
         0 25px 50px rgba(0, 0, 0, 0.5),
         0 10px 20px rgba(0, 0, 0, 0.3),
         0 0 0 1px rgba(255, 255, 255, 0.15);
       animation: tooltipFadeIn 0.3s ease;
       pointer-events: none;
       font-weight: 500;
       text-align: left;
       word-wrap: break-word;
       overflow-wrap: break-word;
       font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
     }

    .skip-link {
      position: absolute;
      top: -9999px;
      left: -9999px;
      background: var(--primary-500);
      color: white;
      padding: var(--space-3) var(--space-4);
      text-decoration: none;
      border-radius: var(--radius);
      z-index: 10000;
      font-weight: 600;
      font-size: 0.875rem;
    }

         .skip-link:focus {
       top: 20px;
       left: 20px;
     }

     /* Compact View Styles */
     body.compact .page-layout {
        grid-template-columns: 1fr;
       gap: var(--space-4);
     }

     body.compact .nav-sidebar {
       display: none;
     }

     body.compact .main-content {
       max-width: 1200px;
       margin: 0 auto;
     }

     body.compact .chat-container {
       height: calc(80vh - var(--space-8));
     }

     body.compact .code-output {
       max-height: 200px;
     }

     /* Visual indicator for compact mode */
     body.compact::before {
       content: 'üì± Compact Mode';
       position: fixed;
       top: 20px;
       right: 20px;
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       padding: 8px 16px;
       border-radius: 20px;
       font-size: 0.75rem;
       font-weight: 600;
       z-index: 1000;
       animation: slideIn 0.3s ease;
     }

     @keyframes slideIn {
       from {
         transform: translateX(100%);
         opacity: 0;
       }
       to {
         transform: translateX(0);
         opacity: 1;
       }
     }

     /* Responsive adjustments for compact view */
     @media (max-width: 768px) {
       body.compact .page-layout {
         grid-template-columns: 1fr;
         padding: 0 var(--space-4);
       }
       
       body.compact .main-content {
         padding: var(--space-4);
       }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div class="page-layout">
    <aside class="nav-sidebar">
      <div class="glass-panel" style="padding: var(--space-6);">
        <h3 style="margin-bottom: var(--space-4);">ü§ñ Agents</h3>
        
        <div style="margin-bottom: var(--space-4);">
          <h4 style="margin-bottom: var(--space-3);">üìö Documentation</h4>
          <div style="display: flex; flex-direction: column; gap: var(--space-2);">
            <a href="https://planeszwalker.github.io/LCCWeb/GDD.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-gamepad"></i> Game Design Document
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/technical-spec.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-cogs"></i> Technical Specifications
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/rules.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-book"></i> Project Rules
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/" class="btn btn-secondary" target="_blank">
              <i class="fas fa-home"></i> Back to Home
            </a>
          </div>
        </div>

        <div style="margin-bottom: var(--space-4);">
          <h4 style="margin-bottom: var(--space-2);">Available Agents</h4>
                                                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                               <label class="agent-chip active" data-tooltip="üéØ COORDINATOR AGENT&#10;&#10;üìã PURPOSE&#10;Orchestrates and manages the overall workflow between different agents. Acts as the central intelligence that coordinates tasks and ensures smooth collaboration.&#10;&#10;‚è∞ WHEN TO USE&#10;Always active by default. Use for complex multi-step tasks, project management, or when you need agents to work together systematically.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Task delegation&#10;‚Ä¢ Progress tracking&#10;‚Ä¢ Conflict resolution&#10;‚Ä¢ Workflow optimization&#10;‚Ä¢ Result synthesis&#10;&#10;üéØ BEST FOR&#10;Project planning, code reviews, system architecture decisions, and complex problem-solving scenarios.">
                  <input id="input-blkusjgs1" />
                  <span>üéØ Coordinator</span>
             </label>
                               <label class="agent-chip" data-tooltip="üß™ TEST RUNNER AGENT&#10;&#10;üìã PURPOSE&#10;Executes comprehensive testing across your codebase including unit tests, integration tests, and end-to-end testing.&#10;&#10;‚è∞ WHEN TO USE&#10;Before deployments, after code changes, or when you need to verify system stability and functionality.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Automated test execution&#10;‚Ä¢ Test result analysis&#10;‚Ä¢ Coverage reporting&#10;‚Ä¢ Performance testing&#10;‚Ä¢ Bug detection&#10;&#10;üéØ BEST FOR&#10;Quality assurance, regression testing, performance optimization, and ensuring code reliability.">
                  <input id="input-blkusjgs1" />
                  <span>üß™ Test Runner</span>
             </label>
                <label class="agent-chip" data-tooltip="üé® BEAUTIFIER AGENT&#10;&#10;üìã PURPOSE&#10;Automatically formats and beautifies code to improve readability and maintain consistent coding standards.&#10;&#10;‚è∞ WHEN TO USE&#10;After writing new code, before code reviews, or when you want to clean up existing code formatting.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Code formatting&#10;‚Ä¢ Indentation fixing&#10;‚Ä¢ Comment alignment&#10;‚Ä¢ Variable naming consistency&#10;‚Ä¢ Style guide enforcement&#10;&#10;üéØ BEST FOR&#10;Code cleanup, maintaining coding standards, improving code readability, and preparing code for collaboration.">
                  <input id="input-blkusjgs1" />
                  <span>üé® Beautifier</span>
             </label>
                <label class="agent-chip" data-tooltip="üîß FIXER AGENT&#10;&#10;üìã PURPOSE&#10;Identifies and automatically fixes common code issues, bugs, and potential problems in your codebase.&#10;&#10;‚è∞ WHEN TO USE&#10;When you encounter errors, want to improve code quality, or need to resolve technical debt.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Bug detection&#10;‚Ä¢ Code optimization&#10;‚Ä¢ Security vulnerability fixes&#10;‚Ä¢ Dependency updates&#10;‚Ä¢ Performance improvements&#10;&#10;üéØ BEST FOR&#10;Debugging, code maintenance, security hardening, and technical debt reduction.">
                  <input id="input-blkusjgs1" />
                  <span>üîß Fixer</span>
             </label>
                <label class="agent-chip" data-tooltip="üì∏ SCREENSHOT AGENT&#10;&#10;üìã PURPOSE&#10;Captures visual snapshots of your application for documentation, testing, or visual verification purposes.&#10;&#10;‚è∞ WHEN TO USE&#10;For creating documentation, visual regression testing, UI/UX analysis, or when you need to capture the current state of your application.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Full-page screenshots&#10;‚Ä¢ Element-specific captures&#10;‚Ä¢ Responsive design testing&#10;‚Ä¢ Visual comparison&#10;‚Ä¢ Automated visual testing&#10;&#10;üéØ BEST FOR&#10;Documentation, visual testing, UI/UX reviews, and visual regression detection.">
                  <input id="input-blkusjgs1" />
                  <span>üì∏ Screenshot</span>
             </label>
                <label class="agent-chip" data-tooltip="üëÅÔ∏è LLAVA VISION AGENT&#10;&#10;üìã PURPOSE&#10;Analyzes images and visual content using advanced computer vision capabilities to understand and describe visual elements.&#10;&#10;‚è∞ WHEN TO USE&#10;When you need to analyze UI screenshots, understand visual layouts, identify design issues, or extract information from images.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Image analysis&#10;‚Ä¢ Visual element detection&#10;‚Ä¢ Layout understanding&#10;‚Ä¢ Design pattern recognition&#10;‚Ä¢ Visual accessibility assessment&#10;&#10;üéØ BEST FOR&#10;UI/UX analysis, visual design reviews, accessibility testing, and image-based problem solving.">
                  <input id="input-blkusjgs1" />
                  <span>üëÅÔ∏è LLaVA Vision</span>
             </label>
                <label class="agent-chip" data-tooltip="üìã PROJECT COORDINATOR AGENT&#10;&#10;üìã PURPOSE&#10;Manages project structure, documentation, and organizational aspects of your development workflow.&#10;&#10;‚è∞ WHEN TO USE&#10;For project setup, documentation management, file organization, or when you need to maintain project structure and standards.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Project structure management&#10;‚Ä¢ Documentation generation&#10;‚Ä¢ File organization&#10;‚Ä¢ Dependency tracking&#10;‚Ä¢ Project health monitoring&#10;&#10;üéØ BEST FOR&#10;Project initialization, documentation maintenance, file organization, and project structure optimization.">
                  <input id="input-blkusjgs1" />
                  <span>üìã Project Coordinator</span>
                </label>
                <label class="agent-chip" data-tooltip="üåä PROMPT WAVE AGENT&#10;&#10;üìã PURPOSE&#10;Optimizes and enhances prompts for better AI interactions, ensuring more accurate and relevant responses.&#10;&#10;‚è∞ WHEN TO USE&#10;When you need to improve AI responses, create better prompts, or optimize communication with AI systems.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Prompt optimization&#10;‚Ä¢ Context enhancement&#10;‚Ä¢ Response quality improvement&#10;‚Ä¢ AI interaction refinement&#10;&#10;üéØ BEST FOR&#10;Improving AI interactions, prompt engineering, response optimization, and communication enhancement.">
                  <input id="input-blkusjgs1" />
                  <span>üåä Prompt Wave</span>
                </label>
                <label class="agent-chip" data-tooltip="üí¨ DISCUSSION SYSTEM AGENT&#10;&#10;üìã PURPOSE&#10;Facilitates intelligent discussions and conversations between multiple agents, enabling collaborative problem-solving.&#10;&#10;‚è∞ WHEN TO USE&#10;For complex problem-solving that requires multiple perspectives, brainstorming sessions, or when you need agents to discuss and debate solutions.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ Multi-agent conversations&#10;‚Ä¢ Debate facilitation&#10;‚Ä¢ Consensus building&#10;‚Ä¢ Idea synthesis&#10;‚Ä¢ Collaborative decision-making&#10;&#10;üéØ BEST FOR&#10;Complex problem-solving, brainstorming, decision-making processes, and collaborative analysis.">
                  <input id="input-blkusjgs1" />
                  <span>üí¨ Discussion System</span>
                </label>
                <label class="agent-chip" data-tooltip="üìÑ PDF GENERATOR AGENT&#10;&#10;üìã PURPOSE&#10;Creates professional PDF documents from various content sources including code documentation, reports, and project summaries.&#10;&#10;‚è∞ WHEN TO USE&#10;When you need to generate documentation, create reports, export project information, or share formatted content.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ PDF generation&#10;‚Ä¢ Document formatting&#10;‚Ä¢ Content compilation&#10;‚Ä¢ Report creation&#10;‚Ä¢ Professional document preparation&#10;&#10;üéØ BEST FOR&#10;Documentation generation, report creation, content export, and professional document preparation.">
                  <input id="input-blkusjgs1" />
                  <span>üìÑ PDF Generator</span>
                </label>
                <label class="agent-chip" data-tooltip="üéÆ BABYLON GAME AGENT&#10;&#10;üìã PURPOSE&#10;Specializes in 3D game development using Babylon.js, handling 3D graphics, physics, and interactive game elements.&#10;&#10;‚è∞ WHEN TO USE&#10;For 3D game development, 3D visualization projects, interactive 3D applications, or when you need advanced 3D graphics capabilities.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ 3D scene creation&#10;‚Ä¢ Physics simulation&#10;‚Ä¢ Game mechanics&#10;‚Ä¢ 3D asset management&#10;‚Ä¢ Interactive 3D experiences&#10;&#10;üéØ BEST FOR&#10;3D game development, 3D visualization, interactive 3D applications, and advanced graphics projects.">
                  <input id="input-blkusjgs1" />
                  <span>üéÆ Babylon Game</span>
                </label>
                <label class="agent-chip" data-tooltip="üéØ JS2D GAME AGENT&#10;&#10;üìã PURPOSE&#10;Focuses on 2D game development using JavaScript, handling 2D graphics, game mechanics, and interactive elements.&#10;&#10;‚è∞ WHEN TO USE&#10;For 2D game development, interactive 2D applications, educational games, or when you need 2D graphics and game mechanics.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ 2D graphics rendering&#10;‚Ä¢ Game mechanics implementation&#10;‚Ä¢ Sprite management&#10;‚Ä¢ Collision detection&#10;‚Ä¢ 2D animation&#10;&#10;üéØ BEST FOR&#10;2D game development, interactive 2D applications, educational content, and 2D graphics projects.">
                  <input id="input-blkusjgs1" />
                  <span>üéØ JS2D Game</span>
                </label>
                <label class="agent-chip" data-tooltip="üé≤ THREEJS GAME AGENT&#10;&#10;üìã PURPOSE&#10;Specializes in 3D web graphics and applications using Three.js, creating immersive 3D experiences and visualizations.&#10;&#10;‚è∞ WHEN TO USE&#10;For 3D web applications, data visualization, interactive 3D experiences, or when you need advanced 3D web graphics.&#10;&#10;‚ö° CAPABILITIES&#10;‚Ä¢ 3D web graphics&#10;‚Ä¢ Scene management&#10;‚Ä¢ 3D visualization&#10;‚Ä¢ Interactive 3D experiences&#10;‚Ä¢ Web-based 3D applications&#10;&#10;üéØ BEST FOR&#10;3D web applications, data visualization, interactive 3D experiences, and web-based 3D graphics.">
                  <input id="input-blkusjgs1" />
                  <span>üé≤ ThreeJS Game</span>
             </label>
          </div>
        </div>

                 <div style="margin-bottom: var(--space-4);">
           <h4 style="margin-bottom: var(--space-3);">Quick Actions</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
               <button role="button" />
                 <i class="fas fa-plug"></i> Connect
           </button>
               <button role="button" />
                 <i class="fas fa-trash"></i> Clear
           </button>
               <button role="button" />
                 <i class="fas fa-sync-alt"></i> Refresh
           </button>
             </div>
         </div>
      </div>
    </aside>

    <main class="main-content" id="main-content">
      <div class="glass-panel" style="padding: var(--space-6);">
        <div style="text-align: center; margin-bottom: var(--space-8);">
          <h1 style="font-size: 2.5rem; font-weight: 900; margin-bottom: var(--space-3); background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üí¨ Agents Discussion</h1>
          <p style="color: var(--text-secondary); font-size: 1.25rem;">Real-time inter-agent communication and collaboration</p>
        </div>

                                  <form class="prompt-form" id="promptForm" style="display: flex; gap: var(--space-4); margin-bottom: var(--space-6);">
               <input id="input-blkusjgs1" />
               <button role="button" />
                 <i class="fas fa-paper-plane"></i> Send
             </button>
           </form>

        <div class="chat-container">
          <div class="chat" id="chatArea">
            <div class="bubble system">
              <div class="bubble-meta">
                <div class="avatar system">‚öôÔ∏è</div>
                <span>System</span>
                <span class="phase-tag">INFO</span>
                <span id="currentTime"></span>
              </div>
              <div class="bubble-content">
                Welcome to the Agents Discussion interface! Connect to start collaborating with your AI agents.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <aside class="nav-sidebar">
      <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        <div class="glass-panel" style="padding: var(--space-6);">
          <h3 style="margin-bottom: var(--space-4);">üõ†Ô∏è Tools</h3>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
               <button role="button" />
                 <i class="fas fa-search"></i> Analyze Code
             </button>
               <button role="button" />
                 <i class="fas fa-vial"></i> Run Tests
             </button>
               <button role="button" />
                 <i class="fas fa-magic"></i> Beautify
             </button>
               <button role="button" />
                 <i class="fas fa-camera"></i> Screenshot
             </button>
           </div>
        </div>

        <div class="glass-panel" style="padding: var(--space-6);">
          <h3 style="margin-bottom: var(--space-4);">üíª Output</h3>
          <div class="code-output" id="codeOutput">
            <div class="output-placeholder">
              Agent discussions will appear here...
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

                    <button role="button" />
     <i class="fas fa-compress"></i>
   </button>

     <script src="https://planeszwalker.github.io/LCCWeb/config.js"></script>
   <script src="https://planeszwalker.github.io/LCCWeb/api/backend.js"></script>
<script>
     // Ensure config is loaded
     if (!window.LCC_CONFIG) {
       console.warn('LCC_CONFIG not found, using fallback configuration');
       window.LCC_CONFIG = {
         sseBase: 'https://planeszwalker.github.io/LCCWeb',
         ollamaUrl: 'http://localhost:11434'
       };
     }
class AgentsDiscussion {
  constructor() {
    this.messages = [];
    this.sse = null;
    this.isConnected = false;
    this.sseBase = window.LCC_CONFIG.sseBase;
    this.selectedAgents = new Set(['coordinator']);
    this.processedMessages = new Set();
    
    this.init();
  }

  init() {
    this.bindEvents();
    this.updateTime();
    this.setupAgentChips();
    this.setupToolButtons();
    
    setTimeout(() => {
    this.connect();
    }, 1000);
    
    setInterval(() => this.updateTime(), 1000);
  }

  bindEvents() {
    const form = document.getElementById('promptForm');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.sendMessage();
      });
    }

    const connectBtn = document.getElementById('connectBtn');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    if (connectBtn) {
      connectBtn.addEventListener('click', () => {
        if (this.isConnected) {
          this.disconnect();
        } else {
          this.connect();
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        this.clearMessages();
      });
    }

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        this.connect();
      });
    }

    const fabToggle = document.getElementById('fabToggle');
    if (fabToggle) {
      fabToggle.addEventListener('click', () => {
        this.toggleCompactView();
      });
    }
  }

  setupAgentChips() {
    const agentChips = document.querySelectorAll('.agent-chip');
    agentChips.forEach(chip => {
       const checkbox = chip.querySelector('.agent-checkbox');
      if (checkbox) {
         // Set initial state for coordinator
         if (checkbox.id === 'agent-coordinator' && checkbox.checked) {
           chip.classList.add('active');
         }
         
        checkbox.addEventListener('change', (e) => {
           const agentName = e.target.id.replace('agent-', '');
          if (e.target.checked) {
             this.selectedAgents.add(agentName);
            chip.classList.add('active');
          } else {
             this.selectedAgents.delete(agentName);
            chip.classList.remove('active');
          }
           console.log('Selected agents:', Array.from(this.selectedAgents));
         });
         
         // Also handle click on the chip itself
         chip.addEventListener('click', (e) => {
           if (e.target === checkbox) return; // Don't double-handle checkbox clicks
           checkbox.checked = !checkbox.checked;
           checkbox.dispatchEvent(new Event('change'));
         });
       }

       // Add tooltip functionality
       const tooltipText = chip.getAttribute('data-tooltip');
       if (tooltipText) {
         chip.addEventListener('mouseenter', (e) => {
           this.showTooltip(tooltipText, e);
         });
         
         chip.addEventListener('mouseleave', () => {
           this.hideTooltip();
         });
       }
    });
  }

  showTooltip(text, event) {
    // Remove any existing tooltip
    this.hideTooltip();
    
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = text;
    
    // Add to body to ensure it's above everything
    document.body.appendChild(tooltip);
    
    // Store reference for removal
    this.currentTooltip = tooltip;
  }

  hideTooltip() {
    if (this.currentTooltip) {
      this.currentTooltip.remove();
      this.currentTooltip = null;
    }
  }

  getRelevantAgents(prompt) {
    const p = prompt.toLowerCase();
    const relevantAgents = new Set();
    
    // Always include coordinator for synthesis
    relevantAgents.add('coordinator');
    
    // Image analysis with LLaVA
    if (/\b(image|screenshot|photo|picture|capture|√©cran|image|photo)\b/i.test(p) && 
        /\b(describe|analyze|explain|what|d√©crire|analyser|expliquer|quoi)\b/i.test(p)) {
      relevantAgents.add('llava-agent');
    }

    // Testing tasks
    if (/(run|launch|start)\s+(all\s+)?tests?|test\s*suite|run\s*e2e|run\s*unit|lighthouse|axe|accessibilit|perf|performance/.test(p)) {
      relevantAgents.add('test-runner');
    }

    // Code generation and file creation
    if (/(ecris|√©cris|creer|cr√©er|cr√©e|create|write)\b/.test(p) && /(html|css|js)\b/.test(p)) {
      relevantAgents.add('project-coordinator');
    }

    // Styling and theming
    if (/dark|theme|style|harmonis(er|e)|css|brace|sanitize|validation|selector|duplicate/.test(p)) {
      relevantAgents.add('website-beautifier');
      relevantAgents.add('fixer-agent');
    }

    // Game development
    if (/babylon|3d|unified/.test(p)) {
      relevantAgents.add('babylon-game-finisher');
    }
    if (/three\.js|threejs|three\b/.test(p)) {
      relevantAgents.add('threejs-game-finisher');
    }
    if (/2d|canvas|classique/.test(p)) {
      relevantAgents.add('js2d-game-finisher');
    }

    // Screenshot and documentation
    if (/screenshot|capture|photo|image/.test(p)) {
      relevantAgents.add('screenshot-agent');
    }

    // General analysis and fixing
    if (/analyze|fix|problem|issue|bug|error/.test(p)) {
      relevantAgents.add('fixer-agent');
    }

    // If no specific agents identified, use coordinator and fixer
    if (relevantAgents.size === 1) {
      relevantAgents.add('fixer-agent');
    }
    
    return Array.from(relevantAgents);
  }

  synthesizeAgentResponses(userPrompt, agentResponses) {
    if (agentResponses.length === 0) {
      return "‚ùå **Coordinator**: No agents were able to process your request. Please try rephrasing your question.";
    }

    // Filter out error responses
    const validResponses = agentResponses.filter(response => response.phase !== 'ERROR');
    
    if (validResponses.length === 0) {
      return "‚ùå **Coordinator**: All agents encountered errors while processing your request. Please check your system configuration.";
    }

    // Build comprehensive response
    let synthesis = `üéØ **Coordinator's Comprehensive Response**\n\n`;
    synthesis += `**User Question**: ${userPrompt}\n\n`;
    synthesis += `**Analysis Summary**: I consulted with ${validResponses.length} specialized agent${validResponses.length > 1 ? 's' : ''} to provide you with a comprehensive answer.\n\n`;

    // Add each agent's contribution
    validResponses.forEach((response, index) => {
      synthesis += `**${response.agent}**: ${response.content}\n\n`;
    });

    // Add final synthesis
    synthesis += `**üéØ Final Answer**: Based on the analysis from ${validResponses.length} agent${validResponses.length > 1 ? 's' : ''}, `;
    
    // Generate a summary based on the responses
    const allContent = validResponses.map(r => r.content).join(' ');
    if (allContent.includes('error') || allContent.includes('Error')) {
      synthesis += `there are some issues that need attention. Please review the detailed responses above for specific recommendations.`;
    } else if (allContent.includes('success') || allContent.includes('Success') || allContent.includes('‚úÖ')) {
      synthesis += `the task has been completed successfully. All agents have provided their expertise and recommendations.`;
    } else {
      synthesis += `I've gathered comprehensive information from the specialized agents. Please review their detailed responses above for complete guidance.`;
    }

    return synthesis;
  }

  setupToolButtons() {
    const toolButtons = {
      'btnAnalyze': 'Analyze the current codebase for issues and improvements',
      'btnTest': 'Run comprehensive tests on the project',
      'btnBeautify': 'Apply beautification and formatting to the codebase',
      'btnScreenshot': 'Take screenshots of the current application state'
    };

    Object.entries(toolButtons).forEach(([id, prompt]) => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.addEventListener('click', () => {
          this.sendToolRequest(prompt);
        });
      }
    });
  }

  updateTime() {
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
      timeElement.textContent = new Date().toLocaleTimeString();
    }
  }

  async sendMessage() {
    const input = document.getElementById('promptInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;

    const userMessage = {
      type: 'user',
      content: message,
      timestamp: new Date(),
      agent: 'User',
      phase: 'PROMPT'
    };
    
    this.addMessage(userMessage);
    this.addToOutput(userMessage);

    input.value = '';

    try {
      // Step 1: Determine which agents are relevant for this prompt
      const relevantAgents = this.getRelevantAgents(message);
      
      // Step 2: Show coordinator is analyzing the request
      const analysisMessage = {
        type: 'agent',
        content: `üîç **Coordinator Analysis**: I'm analyzing your request and will consult with ${relevantAgents.length} specialized agent${relevantAgents.length > 1 ? 's' : ''}: ${relevantAgents.join(', ')}`,
        timestamp: new Date(),
        agent: 'Coordinator',
        phase: 'ANALYSIS'
      };
      this.addToOutput(analysisMessage);
      
      // Step 3: Send request to each relevant agent and collect responses
      const agentResponses = [];
      
      for (const agent of relevantAgents) {
        try {
          const agentRequest = {
            type: 'agent',
            content: `ü§ñ **${agent}**: Processing your request...`,
            timestamp: new Date(),
            agent: agent,
            phase: 'PROCESSING'
          };
          this.addToOutput(agentRequest);
          
          // Send individual request to each agent
          const agentData = await window.LCC_API.handleAPIRequest('prompt', {
            prompt: message,
            agents: [agent]
          });
          
          const agentResponse = {
            type: 'agent',
            content: agentData.response,
            timestamp: new Date(),
            agent: agent,
            phase: 'RESPONSE'
          };
          
          agentResponses.push(agentResponse);
          this.addToOutput(agentResponse);
          
        } catch (error) {
          const errorResponse = {
            type: 'agent',
            content: `‚ùå **${agent}**: Error processing request - ${error.message}`,
            timestamp: new Date(),
            agent: agent,
            phase: 'ERROR'
          };
          agentResponses.push(errorResponse);
          this.addToOutput(errorResponse);
        }
      }
      
      // Step 4: Coordinator synthesizes all responses into a comprehensive answer
      const synthesisMessage = {
        type: 'agent',
        content: `üß† **Coordinator**: Synthesizing responses from ${agentResponses.length} agent${agentResponses.length > 1 ? 's' : ''}...`,
        timestamp: new Date(),
        agent: 'Coordinator',
        phase: 'SYNTHESIS'
      };
      this.addToOutput(synthesisMessage);
      
      // Step 5: Generate final coordinated response
      const finalResponse = this.synthesizeAgentResponses(message, agentResponses);
      
      const coordinatorMessage = {
        type: 'agent',
        content: finalResponse,
        timestamp: new Date(),
        agent: 'Coordinator',
        phase: 'FINAL_ANSWER'
      };
      
      this.addMessage(coordinatorMessage);
      this.addToOutput(coordinatorMessage);
      
    } catch (error) {
      const errorMessage = {
        type: 'system',
        content: `Connection error: ${error.message}`,
        timestamp: new Date(),
        agent: 'System',
        phase: 'ERROR'
      };
      this.addMessage(errorMessage);
      this.addToOutput(errorMessage);
    }
  }

  async sendToolRequest(prompt) {
    const toolMessage = {
      type: 'system',
      content: `Tool request: ${prompt}`,
      timestamp: new Date(),
      agent: 'System',
      phase: 'INFO'
    };
    
    this.addMessage(toolMessage);
    this.addToOutput(toolMessage);

    try {
      const response = await fetch(`${this.sseBase}/prompt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: prompt,
          agents: Array.from(this.selectedAgents)
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      const errorMessage = {
        type: 'system',
        content: `Tool error: ${error.message}`,
        timestamp: new Date(),
        agent: 'System',
        phase: 'ERROR'
      };
      this.addMessage(errorMessage);
      this.addToOutput(errorMessage);
    }
  }

  addMessage(message) {
      // Create a more robust message ID that includes content hash
      const contentHash = this.hashString(message.content);
      const messageId = `${message.agent}-${message.phase}-${contentHash}-${message.timestamp.getTime()}`;
      
      if (this.processedMessages.has(messageId)) {
        console.log('Duplicate message detected, skipping:', message.content.substring(0, 50));
        return;
      }
      
      // Check for recent duplicates with same content and agent (more strict)
      const isDuplicate = this.messages.some(existing => {
        const timeDiff = Math.abs(existing.timestamp.getTime() - message.timestamp.getTime());
        return existing.content === message.content && 
               existing.agent === message.agent && 
               existing.phase === message.phase &&
               timeDiff < 10000; // Increased time window for better filtering
      });
      
      if (isDuplicate) {
        console.log('Duplicate message detected (time-based), skipping:', message.content.substring(0, 50));
        return;
      }
      
      // Additional check: if we have too many similar messages in a short time, skip
      const recentSimilarMessages = this.messages.filter(existing => {
        const timeDiff = Math.abs(existing.timestamp.getTime() - message.timestamp.getTime());
        return timeDiff < 5000 && existing.agent === message.agent;
      });
      
      if (recentSimilarMessages.length > 5) {
        console.log('Too many recent messages from same agent, skipping:', message.content.substring(0, 50));
        return;
      }
      
      this.processedMessages.add(messageId);
      
      // Clean up old processed messages more aggressively
      if (this.processedMessages.size > 500) {
        const keys = Array.from(this.processedMessages.keys());
        keys.slice(0, 100).forEach(key => this.processedMessages.delete(key));
      }
      
    this.messages.push(message);
      
      // Only render if it's a final answer or user message
      if (message.phase === 'ANSWER' || message.phase === 'FINAL' || message.type === 'user') {
    this.renderMessage(message);
      }
    }

   // Simple hash function for content
   hashString(str) {
     let hash = 0;
     if (str.length === 0) return hash;
     for (let i = 0; i < str.length; i++) {
       const char = str.charCodeAt(i);
       hash = ((hash << 5) - hash) + char;
       hash = hash & hash; // Convert to 32bit integer
     }
     return Math.abs(hash);
  }

  renderMessage(message) {
    const chatArea = document.getElementById('chatArea');
    if (!chatArea) return;
    
    const bubble = document.createElement('div');
    bubble.className = `bubble ${message.type}`;
    
    const time = message.timestamp.toLocaleTimeString();
    const agentIcon = this.getAgentIcon(message.agent);
    
    bubble.innerHTML = `
      <div class="bubble-meta">
        <div class="avatar ${message.type}">${agentIcon}</div>
        <span>${message.agent}</span>
        <span class="phase-tag">${message.phase || 'INFO'}</span>
        <span>${time}</span>
      </div>
      <div class="bubble-content">
        ${this.formatMessageContent(message.content)}
      </div>
    `;
    
    chatArea.appendChild(bubble);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  getAgentIcon(agent) {
    const icons = {
      'User': 'üë§',
      'Coordinator': 'üéØ',
      'Test Runner': 'üß™',
      'Beautifier': 'üé®',
      'Fixer': 'üîß',
       'Screenshot': 'üì∏',
       'LLaVA': 'üëÅÔ∏è',
       'Project Coordinator': 'üìã',
       'Prompt Wave': 'üåä',
       'Discussion System': 'üí¨',
       'PDF Generator': 'üìÑ',
       'Babylon Game': 'üéÆ',
       'JS2D Game': 'üéØ',
       'ThreeJS Game': 'üé≤',
      'System': '‚öôÔ∏è'
    };
    return icons[agent] || 'ü§ñ';
  }

  formatMessageContent(content) {
    content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
    content = content.replace(/\n/g, '<br>');
    return content;
  }

  clearMessages() {
    this.messages = [];
    this.processedMessages.clear();
    
    const chatArea = document.getElementById('chatArea');
    if (chatArea) {
    chatArea.innerHTML = `
      <div class="bubble system">
        <div class="bubble-meta">
          <div class="avatar system">‚öôÔ∏è</div>
          <span>System</span>
          <span class="phase-tag">INFO</span>
          <span>${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="bubble-content">
          Messages cleared. Ready for new conversation.
        </div>
      </div>
    `;
    }
    
    const codeOutput = document.getElementById('codeOutput');
    if (codeOutput) {
      codeOutput.innerHTML = `
        <div class="output-placeholder">
          Agent discussions will appear here...
        </div>
      `;
    }
  }

  connect() {
     // Prevent multiple connection attempts
     if (this.connecting) {
       console.log('Connection already in progress, skipping...');
       return;
     }
     
     this.connecting = true;
     
           // For GitHub Pages deployment, use mock connection instead of SSE
      if (window.location.hostname === 'planeszwalker.github.io') {
        console.log('GitHub Pages detected, using mock connection...');
        setTimeout(() => {
          this.isConnected = true;
          this.connecting = false;
          this.updateConnectionStatus('connected', 'Connected (Mock)');
          this.retryCount = 0;
          console.log('Mock connection established for GitHub Pages');
        }, 1000);
        return;
      }
      
      // For local development, use real SSE connection
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Local development detected, using real SSE connection...');
      }
     
     // Close existing connection if any
     if (this.sse && this.sse.readyState !== EventSource.CLOSED) {
       console.log('SSE connection already exists, closing first...');
      this.sse.close();
       this.sse = null;
    }

    try {
       console.log('Connecting to SSE stream...');
      this.sse = new EventSource(`${this.sseBase}/logs/stream?file=latest.log`);
      
      this.sse.onopen = () => {
         console.log('SSE connection opened successfully');
        this.isConnected = true;
         this.connecting = false;
        this.updateConnectionStatus('connected', 'Connected');
         this.retryCount = 0;
      };
      
             this.sse.onmessage = (event) => {
         try {
           if (!event.data || event.data.trim() === '') {
             return;
           }
           
           const trimmedData = event.data.trim();
           
           // Skip non-JSON data (console logs, debug info)
           if (!trimmedData.startsWith('{') || !trimmedData.endsWith('}')) {
             return; // Silently skip non-JSON data
           }
           
           const data = JSON.parse(trimmedData);
           if (!data || !data.text) {
             return;
           }
           
           // Filter out debug messages and console logs
           const text = data.text.toLowerCase();
           if (text.includes('duplicate sse message') || 
               text.includes('incomplete json data') ||
               text.includes('console.log') ||
               text.includes('console.error') ||
               text.includes('modifi√©s:') ||
               text.includes('size:') ||
               text.includes('vague termin√©e') ||
               text.includes('agent ex√©cut√©') ||
               text.includes('üöÄ ex√©cution') ||
               text.includes('üí° instruction') ||
               text.includes('‚úÖ agent') ||
               text.includes('‚ñ∂ node tools') ||
               text.includes('priority:') ||
               text.includes('needs') ||
               text.includes('fixall:') ||
               text.includes('corrections d\'accessibilit√©') ||
               text.includes('c:\\users\\anne\\desktop') ||
               text.includes('public\\') ||
               text.includes('agents-discussion')) {
             return; // Skip debug and system messages
           }
           
           const timestamp = data.timestamp || Date.now();
           
           // Create a more robust message ID using content hash
           const contentHash = this.hashString(data.text);
           const messageId = `${data.agent || 'Agent'}-${data.phase || 'INFO'}-${contentHash}-${timestamp}`;
           
           if (this.processedMessages.has(messageId)) {
             return; // Silently skip duplicates
           }
           
           // Check for recent duplicates with same content (more strict)
           const currentTime = Date.now();
           const isRecentDuplicate = Array.from(this.processedMessages).some(existingId => {
             const parts = existingId.split('-');
             const existingHash = parts[2];
             const existingTimestamp = parseInt(parts[parts.length - 1]);
             
             return existingHash === contentHash.toString() && 
                    Math.abs(currentTime - existingTimestamp) < 3000; // Reduced time window
           });
           
           if (isRecentDuplicate) {
             return; // Silently skip recent duplicates
           }
           
           // Additional check: limit messages per agent per time window
           const recentAgentMessages = this.messages.filter(msg => {
             const timeDiff = Math.abs(msg.timestamp.getTime() - timestamp);
             return msg.agent === (data.agent || 'Agent') && timeDiff < 5000; // Reduced time window
           });
           
           if (recentAgentMessages.length > 5) { // Reduced limit
             return; // Silently skip if too many messages
           }
           
           this.processedMessages.add(messageId);
           
           // Clean up old processed messages more aggressively
           if (this.processedMessages.size > 200) { // Reduced size
             const keys = Array.from(this.processedMessages.keys());
             keys.slice(0, 50).forEach(key => this.processedMessages.delete(key));
           }
           
           // Create message object
           const messageObj = {
             type: data.role === 'user' ? 'user' : 'agent',
             content: data.text,
             timestamp: new Date(timestamp),
             agent: data.agent || 'Agent',
             phase: data.phase || 'INFO'
           };
           
           // Only show final answers in chat, show all discussions in output
           if (data.phase === 'ANSWER' || data.phase === 'FINAL' || data.phase === 'RESULT' || data.phase === 'FINAL_ANSWER') {
             this.addMessage(messageObj);
           }
           
           // Always add to output section for full discussion
           this.addToOutput(messageObj);
         } catch (error) {
           // Silently ignore parsing errors
           return;
         }
       };
      
             this.sse.onerror = (error) => {
         console.error('SSE connection error:', error);
        this.isConnected = false;
         this.connecting = false;
        this.updateConnectionStatus('disconnected', 'Connection Error');
         
         if (!this.retryCount) this.retryCount = 0;
         this.retryCount++;
         
         if (this.retryCount <= 3) {
           const delay = Math.min(1000 * Math.pow(2, this.retryCount - 1), 10000);
           console.log(`SSE connection failed, retrying in ${delay}ms (attempt ${this.retryCount}/3)...`);
           
           setTimeout(() => {
             if (this.retryCount <= 3) {
               this.connect();
             }
           }, delay);
         } else {
           console.log('SSE connection failed after 3 retries, giving up');
           this.retryCount = 0; // Reset for manual retry
         }
      };
      
    } catch (error) {
      console.error('Failed to create SSE connection:', error);
      this.isConnected = false;
      this.updateConnectionStatus('disconnected', 'Connection Failed');
    }
  }

  disconnect() {
    if (this.sse) {
      this.sse.close();
      this.sse = null;
    }
    this.isConnected = false;
    this.updateConnectionStatus('disconnected', 'Disconnected');
  }

  updateConnectionStatus(type, text) {
    const connectBtn = document.getElementById('connectBtn');
    
    if (connectBtn) {
      if (type === 'connected') {
        connectBtn.innerHTML = '<i class="fas fa-unplug"></i> Disconnect';
        connectBtn.classList.remove('btn-primary');
        connectBtn.classList.add('btn-secondary');
         this.isConnected = true;
      } else {
        connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
        connectBtn.classList.remove('btn-secondary');
        connectBtn.classList.add('btn-primary');
         this.isConnected = false;
       }
     }
   }

     addToOutput(message) {
     const codeOutput = document.getElementById('codeOutput');
     if (!codeOutput) return;
     
     const placeholder = codeOutput.querySelector('.output-placeholder');
     if (placeholder) {
       placeholder.remove();
     }
     
     const outputItem = document.createElement('div');
     outputItem.className = 'output-item';
     
     const time = message.timestamp.toLocaleTimeString();
     const agentIcon = this.getAgentIcon(message.agent);
     
     outputItem.innerHTML = `
       <div class="output-meta">
         <span class="output-agent">${agentIcon} ${message.agent}</span>
         <span class="output-phase">${message.phase}</span>
         <span class="output-time">${time}</span>
       </div>
       <div class="output-content">
         ${this.formatMessageContent(message.content)}
       </div>
     `;
     
     codeOutput.appendChild(outputItem);
     codeOutput.scrollTop = codeOutput.scrollHeight;
     
     // Limit output items to prevent overwhelming the interface
     const outputItems = codeOutput.querySelectorAll('.output-item');
     if (outputItems.length > 30) {
       // Remove oldest items in batches
       const itemsToRemove = outputItems.length - 20;
       for (let i = 0; i < itemsToRemove; i++) {
         if (outputItems[i]) {
           outputItems[i].remove();
         }
       }
    }
  }

  toggleCompactView() {
     document.body.classList.toggle('compact');
    
    const fabToggle = document.getElementById('fabToggle');
    if (fabToggle) {
      const icon = fabToggle.querySelector('i');
       if (document.body.classList.contains('compact')) {
        icon.className = 'fas fa-expand';
         console.log('Compact view enabled');
      } else {
        icon.className = 'fas fa-compress';
         console.log('Compact view disabled');
       }
     }
   }
}

// Global variable for agents discussion instance
let agentsDiscussion;

document.addEventListener('DOMContentLoaded', () => {
   console.log('üöÄ Initializing Agents Discussion Interface...');
   try {
     agentsDiscussion = new AgentsDiscussion();
     console.log('‚úÖ Agents Discussion Interface initialized successfully');
   } catch (error) {
     console.error('‚ùå Error initializing Agents Discussion Interface:', error);
   }
});
</script>
</body>
</html>
