<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Agents IA - Letters Cascade Challenge</title>
    <meta name="description" content="Plateforme de discussion avec agents IA">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎮</text></svg>">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Unified CSS System -->
    <link rel="stylesheet" href="../../assets/css/unified-colors.css">
    <link rel="stylesheet" href="../../assets/css/unified-layout.css">
    <link rel="stylesheet" href="../../assets/css/shared.css">
    <link rel="stylesheet" href="../../assets/css/theme-dark.css">
    <link rel="stylesheet" href="../../assets/css/enhanced-ui.css">
    <link rel="stylesheet" href="../../assets/css/unified-enhanced.css">
    
    <!-- Page-specific CSS -->
    <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-primary);
      background: var(--gradient-bg-primary);
      color: var(--text-primary);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    .page-layout {
      display: grid;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 var(--space-6);
      gap: var(--space-8);
      grid-template-columns: 400px minmax(0, 1fr) 450px;
      min-height: calc(100vh - 120px);
    }

    .nav-sidebar {
      position: sticky;
      top: var(--space-4);
      align-self: start;
    }

    .main-content {
      min-height: 80vh;
    }

    /* Button styles removed - using unified colors from unified-colors.css */

    .prompt-input {
      flex: 1;
      padding: var(--space-4) var(--space-5);
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
                      color: var(--neutral-800);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .prompt-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .chat-container {
      height: calc(70vh - var(--space-8));
      overflow: hidden;
    }

    .chat {
      height: 100%;
      overflow-y: auto;
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

          .bubble {
        max-width: 85%;
        padding: var(--space-6) var(--space-8);
        border-radius: var(--radius-xl);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 
          0 12px 40px rgba(0, 0, 0, 0.2),
          0 6px 20px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

    .bubble.agent {
      align-self: flex-start;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(129, 140, 248, 0.1));
      border-left: 4px solid var(--primary-500);
    }

    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(20, 184, 166, 0.1));
                      border-right: 4px solid var(--accent-color);
    }

    .bubble.system {
      align-self: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.05));
      border: 1px dashed rgba(255, 255, 255, 0.3);
      max-width: 70%;
    }

    .bubble-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .avatar {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 0.75rem;
      color: white;
      font-weight: 600;
    }

    .avatar.agent { background: var(--primary); }
    .avatar.user { background: var(--success); }
            .avatar.system { background: var(--warning-color); }

    .phase-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--primary);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .code-output {
      margin-top: 1rem;
      max-height: 300px;
      overflow: auto;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: 'Inter', sans-serif;
                  color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .output-item {
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary-500);
      transition: all 0.3s ease;
    }

    .output-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .output-agent {
      font-weight: 600;
                  color: var(--primary-400);
    }

    .output-phase {
      padding: 0.2rem 0.5rem;
      background: var(--primary);
      color: white;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .output-content {
      color: var(--text-primary);
      line-height: 1.6;
      word-wrap: break-word;
    }

          .agent-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 10px 18px;
        border-radius: 9999px;
        border: 1px solid rgba(255,255,255,0.2);
        background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
        backdrop-filter: blur(15px);
        font-weight: 500;
        font-size: 0.875rem;
        box-shadow: 
          0 4px 12px rgba(0, 0, 0, 0.15),
          0 2px 6px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

     .agent-chip:hover {
       background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      color: var(--text-primary);
       transform: translateY(-2px);
       box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
       border-color: rgba(255, 255, 255, 0.25);
     }

     .agent-chip input.agent-checkbox {
       width: 16px;
       height: 16px;
       margin: 0;
     }

           .agent-chip.active {
        background: linear-gradient(135deg, rgba(102,126,234,0.25), rgba(102,126,234,0.15));
        border-color: rgba(102,126,234,0.6);
        color: var(--text-primary);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
      }

                                /* Tooltip Styles */
                   .agent-chip {
                     position: relative;
                   }
             
                   .agent-chip[data-tooltip]:hover::after {
                     content: attr(data-tooltip);
                     position: fixed;
                     left: 50%;
                     top: 50%;
                     transform: translate(-50%, -50%);
                     padding: 20px 24px;
                     background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
                     backdrop-filter: blur(20px);
                     border: 2px solid rgba(102, 126, 234, 0.4);
                     border-radius: 16px;
                     color: var(--text-primary);
                     font-size: 0.9rem;
                     line-height: 1.6;
                     white-space: pre-line;
                     max-width: 400px;
                     min-width: 300px;
                     z-index: 999999;
                     box-shadow: 
                       0 25px 50px rgba(0, 0, 0, 0.5),
                       0 10px 20px rgba(0, 0, 0, 0.3),
                       0 0 0 1px rgba(255, 255, 255, 0.15);
                     animation: tooltipFadeIn 0.3s ease;
                     pointer-events: none;
                     font-weight: 500;
                     text-align: left;
                     word-wrap: break-word;
                     overflow-wrap: break-word;
                   }
             
                   /* Remove arrow for centered tooltip */
                   .agent-chip[data-tooltip]:hover::before {
                     display: none;
                   }
             
                   @keyframes tooltipFadeIn {
                     from {
                       opacity: 0;
                       transform: translateY(-50%) scale(0.95);
                     }
                     to {
                       opacity: 1;
                       transform: translateY(-50%) scale(1);
                     }
                   }
             
                   /* Responsive tooltip positioning */
                   @media (max-width: 1200px) {
                     .agent-chip[data-tooltip]:hover::after {
                       max-width: 80vw;
                       min-width: 280px;
                       font-size: 0.85rem;
                       padding: 18px 22px;
                     }
                   }
             
                   /* Mobile tooltip adjustments */
                   @media (max-width: 768px) {
                     .agent-chip[data-tooltip]:hover::after {
                       max-width: 95vw;
                       min-width: 280px;
                       font-size: 0.8rem;
                       padding: 16px 20px;
                       border-radius: 12px;
                     }
                   }

     .fab {
       position: fixed;
       bottom: 2rem;
       right: 2rem;
       width: 64px;
       height: 64px;
       border-radius: 50%;
                   background: var(--gradient-primary);
       color: white;
       border: 2px solid rgba(255, 255, 255, 0.2);
       cursor: pointer;
       box-shadow: 
         0 12px 40px rgba(102, 126, 234, 0.5),
         0 6px 20px rgba(102, 126, 234, 0.3);
       transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
       z-index: 50;
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 1.2rem;
       backdrop-filter: blur(20px);
     }

     .fab:hover {
       transform: translateY(-6px) scale(1.1);
       box-shadow: 
         0 20px 60px rgba(102, 126, 234, 0.7),
         0 10px 30px rgba(102, 126, 234, 0.5);
       border-color: rgba(255, 255, 255, 0.4);
     }

     .fab:active {
       transform: translateY(-3px) scale(0.95);
       transition: transform 0.1s ease;
     }

     .fab:focus {
       outline: 2px solid var(--primary-color);
       outline-offset: 2px;
       box-shadow: var(--shadow-primary);
     }

    .skip-link {
      position: absolute;
      top: -9999px;
      left: -9999px;
      background: var(--primary-500);
      color: white;
      padding: var(--space-3) var(--space-4);
      text-decoration: none;
      border-radius: var(--radius);
      z-index: 10000;
      font-weight: 600;
      font-size: 0.875rem;
    }

         .skip-link:focus {
       top: 20px;
       left: 20px;
     }

     /* Compact View Styles */
     body.compact .page-layout {
        grid-template-columns: 1fr;
       gap: var(--space-4);
     }

     body.compact .nav-sidebar {
       display: none;
     }

     body.compact .main-content {
       max-width: 1200px;
       margin: 0 auto;
     }

     body.compact .chat-container {
       height: calc(80vh - var(--space-8));
     }

     body.compact .code-output {
       max-height: 200px;
     }

     /* Visual indicator for compact mode */
     body.compact::before {
       content: '📱 Compact Mode';
       position: fixed;
       top: 20px;
       right: 20px;
                   background: var(--gradient-primary);
       color: white;
       padding: 8px 16px;
       border-radius: 20px;
       font-size: 0.75rem;
       font-weight: 600;
       z-index: 1000;
       animation: slideIn 0.3s ease;
     }

     @keyframes slideIn {
       from {
         transform: translateX(100%);
         opacity: 0;
       }
       to {
         transform: translateX(0);
         opacity: 1;
       }
     }

     /* Responsive adjustments for compact view */
     @media (max-width: 768px) {
       body.compact .page-layout {
         grid-template-columns: 1fr;
         padding: 0 var(--space-4);
       }
       
       body.compact .main-content {
         padding: var(--space-4);
       }
    }
  </style>
    
    <style>
        /* Base page styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-600) 100%);
            color: var(--neutral-50);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Unified Navigation */
        .unified-nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .unified-nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .unified-nav-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-600);
            text-decoration: none;
        }
        
        .unified-nav-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .unified-nav-link {
            color: var(--neutral-700);
            text-decoration: none;
            font-weight: 500;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: all var(--transition-normal);
        }
        
        .unified-nav-link:hover {
            color: var(--primary-600);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .unified-nav-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--neutral-700);
            font-size: 1.25rem;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
        }
        
        /* Main Content */
        .main-content {
            margin-top: 70px;
            min-height: calc(100vh - 70px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        /* Glass Panel System */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: var(--spacing-xl);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all var(--transition-normal);
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition-normal);
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--neutral-700);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .unified-nav-menu {
                display: none;
            }
            
            .unified-nav-menu.active {
                display: flex;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding: var(--spacing-lg);
                box-shadow: var(--shadow-lg);
            }
            
            .unified-nav-toggle {
                display: block;
            }
            
            .container {
                padding: var(--spacing-lg);
            }
            
            .glass-panel {
                padding: var(--spacing-xl);
            }
        }
    </style>
</head>
<body>
    <!-- Unified Navigation -->
    <header class="unified-nav-header">
        <div class="unified-nav-container">
            <a href="../../" class="unified-nav-brand">
                <i class="fas fa-gamepad"></i>
                Letters Cascade
            </a>
            
            <nav>
                <ul class="unified-nav-menu" id="nav-menu">
                    <li><a href="../../" class="unified-nav-link">Accueil</a></li>
                    <li><a href="./" class="unified-nav-link">Jeux</a></li>
                    <li><a href="../docs/" class="unified-nav-link">Documentation</a></li>
                    <li><a href="../docs/rules.html" class="unified-nav-link">Règles</a></li>
                </ul>
            </nav>
            
            <button class="unified-nav-toggle" id="nav-toggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Unified Navigation -->
    

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div class="page-layout">
    <aside class="nav-sidebar">
      <div class="glass-panel" style="padding: var(--space-6);">
        <h3 style="margin-bottom: var(--space-4);">🤖 Agents</h3>
        
        <div style="margin-bottom: var(--space-4);">
          <h4 style="margin-bottom: var(--space-3);">📚 Documentation</h4>
          <div style="display: flex; flex-direction: column; gap: var(--space-2);">
            <a href="https://planeszwalker.github.io/LCCWeb/GDD.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-gamepad"></i> Game Design Document
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/technical-spec.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-cogs"></i> Technical Specifications
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/rules.html" class="btn btn-secondary" target="_blank">
              <i class="fas fa-book"></i> Project Rules
            </a>
            <a href="https://planeszwalker.github.io/LCCWeb/" class="btn btn-secondary" target="_blank">
              <i class="fas fa-home"></i> Back to Home
            </a>
          </div>
        </div>

        <div style="margin-bottom: var(--space-4);">
          <h4 style="margin-bottom: var(--space-2);">Available Agents</h4>
                                                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                               <label class="agent-chip active" data-tooltip="🎯 COORDINATOR AGENT&#10;&#10;📋 PURPOSE&#10;Orchestrates and manages the overall workflow between different agents. Acts as the central intelligence that coordinates tasks and ensures smooth collaboration.&#10;&#10;⏰ WHEN TO USE&#10;Always active by default. Use for complex multi-step tasks, project management, or when you need agents to work together systematically.&#10;&#10;⚡ CAPABILITIES&#10;• Task delegation&#10;• Progress tracking&#10;• Conflict resolution&#10;• Workflow optimization&#10;• Result synthesis&#10;&#10;🎯 BEST FOR&#10;Project planning, code reviews, system architecture decisions, and complex problem-solving scenarios.">
                  <input id="input-p27p0dp1s" />
                  <span>🎯 Coordinator</span>
             </label>
                               <label class="agent-chip" data-tooltip="🧪 TEST RUNNER AGENT&#10;&#10;📋 PURPOSE&#10;Executes comprehensive testing across your codebase including unit tests, integration tests, and end-to-end testing.&#10;&#10;⏰ WHEN TO USE&#10;Before deployments, after code changes, or when you need to verify system stability and functionality.&#10;&#10;⚡ CAPABILITIES&#10;• Automated test execution&#10;• Test result analysis&#10;• Coverage reporting&#10;• Performance testing&#10;• Bug detection&#10;&#10;🎯 BEST FOR&#10;Quality assurance, regression testing, performance optimization, and ensuring code reliability.">
                  <input id="input-p27p0dp1s" />
                  <span>🧪 Test Runner</span>
             </label>
                <label class="agent-chip" data-tooltip="🎨 BEAUTIFIER AGENT&#10;&#10;📋 PURPOSE&#10;Automatically formats and beautifies code to improve readability and maintain consistent coding standards.&#10;&#10;⏰ WHEN TO USE&#10;After writing new code, before code reviews, or when you want to clean up existing code formatting.&#10;&#10;⚡ CAPABILITIES&#10;• Code formatting&#10;• Indentation fixing&#10;• Comment alignment&#10;• Variable naming consistency&#10;• Style guide enforcement&#10;&#10;🎯 BEST FOR&#10;Code cleanup, maintaining coding standards, improving code readability, and preparing code for collaboration.">
                  <input id="input-p27p0dp1s" />
                  <span>🎨 Beautifier</span>
             </label>
                <label class="agent-chip" data-tooltip="🔧 FIXER AGENT&#10;&#10;📋 PURPOSE&#10;Identifies and automatically fixes common code issues, bugs, and potential problems in your codebase.&#10;&#10;⏰ WHEN TO USE&#10;When you encounter errors, want to improve code quality, or need to resolve technical debt.&#10;&#10;⚡ CAPABILITIES&#10;• Bug detection&#10;• Code optimization&#10;• Security vulnerability fixes&#10;• Dependency updates&#10;• Performance improvements&#10;&#10;🎯 BEST FOR&#10;Debugging, code maintenance, security hardening, and technical debt reduction.">
                  <input id="input-p27p0dp1s" />
                  <span>🔧 Fixer</span>
             </label>
                <label class="agent-chip" data-tooltip="📸 SCREENSHOT AGENT&#10;&#10;📋 PURPOSE&#10;Captures visual snapshots of your application for documentation, testing, or visual verification purposes.&#10;&#10;⏰ WHEN TO USE&#10;For creating documentation, visual regression testing, UI/UX analysis, or when you need to capture the current state of your application.&#10;&#10;⚡ CAPABILITIES&#10;• Full-page screenshots&#10;• Element-specific captures&#10;• Responsive design testing&#10;• Visual comparison&#10;• Automated visual testing&#10;&#10;🎯 BEST FOR&#10;Documentation, visual testing, UI/UX reviews, and visual regression detection.">
                  <input id="input-p27p0dp1s" />
                  <span>📸 Screenshot</span>
             </label>
                <label class="agent-chip" data-tooltip="👁️ LLAVA VISION AGENT&#10;&#10;📋 PURPOSE&#10;Analyzes images and visual content using advanced computer vision capabilities to understand and describe visual elements.&#10;&#10;⏰ WHEN TO USE&#10;When you need to analyze UI screenshots, understand visual layouts, identify design issues, or extract information from images.&#10;&#10;⚡ CAPABILITIES&#10;• Image analysis&#10;• Visual element detection&#10;• Layout understanding&#10;• Design pattern recognition&#10;• Visual accessibility assessment&#10;&#10;🎯 BEST FOR&#10;UI/UX analysis, visual design reviews, accessibility testing, and image-based problem solving.">
                  <input id="input-p27p0dp1s" />
                  <span>👁️ LLaVA Vision</span>
             </label>
                <label class="agent-chip" data-tooltip="📋 PROJECT COORDINATOR AGENT&#10;&#10;📋 PURPOSE&#10;Manages project structure, documentation, and organizational aspects of your development workflow.&#10;&#10;⏰ WHEN TO USE&#10;For project setup, documentation management, file organization, or when you need to maintain project structure and standards.&#10;&#10;⚡ CAPABILITIES&#10;• Project structure management&#10;• Documentation generation&#10;• File organization&#10;• Dependency tracking&#10;• Project health monitoring&#10;&#10;🎯 BEST FOR&#10;Project initialization, documentation maintenance, file organization, and project structure optimization.">
                  <input id="input-p27p0dp1s" />
                  <span>📋 Project Coordinator</span>
                </label>
                <label class="agent-chip" data-tooltip="🌊 PROMPT WAVE AGENT&#10;&#10;📋 PURPOSE&#10;Optimizes and enhances prompts for better AI interactions, ensuring more accurate and relevant responses.&#10;&#10;⏰ WHEN TO USE&#10;When you need to improve AI responses, create better prompts, or optimize communication with AI systems.&#10;&#10;⚡ CAPABILITIES&#10;• Prompt optimization&#10;• Context enhancement&#10;• Response quality improvement&#10;• AI interaction refinement&#10;&#10;🎯 BEST FOR&#10;Improving AI interactions, prompt engineering, response optimization, and communication enhancement.">
                  <input id="input-p27p0dp1s" />
                  <span>🌊 Prompt Wave</span>
                </label>
                <label class="agent-chip" data-tooltip="💬 DISCUSSION SYSTEM AGENT&#10;&#10;📋 PURPOSE&#10;Facilitates intelligent discussions and conversations between multiple agents, enabling collaborative problem-solving.&#10;&#10;⏰ WHEN TO USE&#10;For complex problem-solving that requires multiple perspectives, brainstorming sessions, or when you need agents to discuss and debate solutions.&#10;&#10;⚡ CAPABILITIES&#10;• Multi-agent conversations&#10;• Debate facilitation&#10;• Consensus building&#10;• Idea synthesis&#10;• Collaborative decision-making&#10;&#10;🎯 BEST FOR&#10;Complex problem-solving, brainstorming, decision-making processes, and collaborative analysis.">
                  <input id="input-p27p0dp1s" />
                  <span>💬 Discussion System</span>
                </label>
                <label class="agent-chip" data-tooltip="📄 PDF GENERATOR AGENT&#10;&#10;📋 PURPOSE&#10;Creates professional PDF documents from various content sources including code documentation, reports, and project summaries.&#10;&#10;⏰ WHEN TO USE&#10;When you need to generate documentation, create reports, export project information, or share formatted content.&#10;&#10;⚡ CAPABILITIES&#10;• PDF generation&#10;• Document formatting&#10;• Content compilation&#10;• Report creation&#10;• Professional document preparation&#10;&#10;🎯 BEST FOR&#10;Documentation generation, report creation, content export, and professional document preparation.">
                  <input id="input-p27p0dp1s" />
                  <span>📄 PDF Generator</span>
                </label>
                <label class="agent-chip" data-tooltip="🎮 BABYLON GAME AGENT&#10;&#10;📋 PURPOSE&#10;Specializes in 3D game development using Babylon.js, handling 3D graphics, physics, and interactive game elements.&#10;&#10;⏰ WHEN TO USE&#10;For 3D game development, 3D visualization projects, interactive 3D applications, or when you need advanced 3D graphics capabilities.&#10;&#10;⚡ CAPABILITIES&#10;• 3D scene creation&#10;• Physics simulation&#10;• Game mechanics&#10;• 3D asset management&#10;• Interactive 3D experiences&#10;&#10;🎯 BEST FOR&#10;3D game development, 3D visualization, interactive 3D applications, and advanced graphics projects.">
                  <input id="input-p27p0dp1s" />
                  <span>🎮 Babylon Game</span>
                </label>
                <label class="agent-chip" data-tooltip="🎯 JS2D GAME AGENT&#10;&#10;📋 PURPOSE&#10;Focuses on 2D game development using JavaScript, handling 2D graphics, game mechanics, and interactive elements.&#10;&#10;⏰ WHEN TO USE&#10;For 2D game development, interactive 2D applications, educational games, or when you need 2D graphics and game mechanics.&#10;&#10;⚡ CAPABILITIES&#10;• 2D graphics rendering&#10;• Game mechanics implementation&#10;• Sprite management&#10;• Collision detection&#10;• 2D animation&#10;&#10;🎯 BEST FOR&#10;2D game development, interactive 2D applications, educational content, and 2D graphics projects.">
                  <input id="input-p27p0dp1s" />
                  <span>🎯 JS2D Game</span>
                </label>
                <label class="agent-chip" data-tooltip="🎲 THREEJS GAME AGENT&#10;&#10;📋 PURPOSE&#10;Specializes in 3D web graphics and applications using Three.js, creating immersive 3D experiences and visualizations.&#10;&#10;⏰ WHEN TO USE&#10;For 3D web applications, data visualization, interactive 3D experiences, or when you need advanced 3D web graphics.&#10;&#10;⚡ CAPABILITIES&#10;• 3D web graphics&#10;• Scene management&#10;• 3D visualization&#10;• Interactive 3D experiences&#10;• Web-based 3D applications&#10;&#10;🎯 BEST FOR&#10;3D web applications, data visualization, interactive 3D experiences, and web-based 3D graphics.">
                  <input id="input-p27p0dp1s" />
                  <span>🎲 ThreeJS Game</span>
             </label>
          </div>
        </div>

                 <div style="margin-bottom: var(--space-4);">
           <h4 style="margin-bottom: var(--space-3);">Quick Actions</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                               <button role="button" />
                  <i class="fas fa-plug"></i> Connect
            </button>
                <button role="button" />
                  <i class="fas fa-trash"></i> Clear
            </button>
                <button role="button" />
                  <i class="fas fa-sync-alt"></i> Refresh
            </button>
             </div>
         </div>
      </div>
    </aside>

    <main class="main-content" id="main-content">
      <div class="glass-panel" style="padding: var(--space-6);">
        <div style="text-align: center; margin-bottom: var(--space-8);">
          <h1 style="font-size: 2.5rem; font-weight: 900; margin-bottom: var(--space-3); background: var(--gradient-title); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">💬 Agents Discussion</h1>
          <p style="color: var(--text-secondary); font-size: 1.25rem;">Real-time inter-agent communication and collaboration</p>
        </div>

                                  <form class="prompt-form" id="promptForm" style="display: flex; gap: var(--space-4); margin-bottom: var(--space-6);">
               <input id="input-p27p0dp1s" />
               <button role="button" />
                 <i class="fas fa-paper-plane"></i> Send
             </button>
           </form>

        <div class="chat-container">
          <div class="chat" id="chatArea">
            <div class="bubble system">
              <div class="bubble-meta">
                <div class="avatar system">⚙️</div>
                <span>System</span>
                <span class="phase-tag">INFO</span>
                <span id="currentTime"></span>
              </div>
              <div class="bubble-content">
                Welcome to the Agents Discussion interface! Connect to start collaborating with your AI agents.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <aside class="nav-sidebar">
      <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        <div class="glass-panel" style="padding: var(--space-6);">
          <h3 style="margin-bottom: var(--space-4);">🛠️ Tools</h3>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
               <button role="button" />
                 <i class="fas fa-search"></i> Analyze Code
             </button>
               <button role="button" />
                 <i class="fas fa-vial"></i> Run Tests
             </button>
               <button role="button" />
                 <i class="fas fa-magic"></i> Beautify
             </button>
               <button role="button" />
                 <i class="fas fa-camera"></i> Screenshot
             </button>
           </div>
        </div>

        <div class="glass-panel" style="padding: var(--space-6);">
          <h3 style="margin-bottom: var(--space-4);">💻 Output</h3>
          <div class="code-output" id="codeOutput">
            <div class="output-placeholder">
              Agent discussions will appear here...
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

                                         <button role="button" />
       <i class="fas fa-compress"></i>
     </button>
        </div>
    </main>

    <!-- Footer -->
    

    <!-- Navigation Script -->
    

    <!-- Page-specific JavaScript -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="glass-panel" style="margin-top: var(--spacing-2xl); text-align: center;">
        <p>&copy; 2025 Letters Cascade Challenge. Tous droits réservés.</p>
    </footer>

    <!-- Navigation Script -->
    <script>
        // Mobile navigation toggle
        const navToggle = document.getElementById('nav-toggle');
        const navMenu = document.getElementById('nav-menu');
        
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
                navToggle.setAttribute('aria-expanded', !isExpanded);
                navMenu.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!navToggle.contains(event.target) && !navMenu.contains(event.target)) {
                    navMenu.classList.remove('active');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }
        
        // Hide/show navigation on scroll
        let lastScrollTop = 0;
        const navHeader = document.querySelector('.unified-nav-header');
        
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                navHeader.style.transform = 'translateY(-100%)';
            } else {
                navHeader.style.transform = 'translateY(0)';
            }
            
            lastScrollTop = scrollTop;
        });
    </script>

    <!-- Page-specific JavaScript -->
    
<script src="https://planeszwalker.github.io/LCCWeb/config.js"></script>
<script src="https://planeszwalker.github.io/LCCWeb/api/backend.js"></script>
<script>
     // Ensure config is loaded
     if (!window.LCC_CONFIG) {
       console.warn('LCC_CONFIG not found, using fallback configuration');
       window.LCC_CONFIG = {
         sseBase: 'https://planeszwalker.github.io/LCCWeb',
         ollamaUrl: 'http://localhost:11434'
       };
     }
class AgentsDiscussion {
  constructor() {
    this.messages = [];
    this.sse = null;
    this.isConnected = false;
    this.sseBase = window.LCC_CONFIG.sseBase;
    this.selectedAgents = new Set(['coordinator']);
    this.processedMessages = new Set();
    
    this.init();
  }

  init() {
    this.bindEvents();
    this.updateTime();
    this.setupAgentChips();
    this.setupToolButtons();
    
    setTimeout(() => {
    this.connect();
    }, 1000);
    
    setInterval(() => this.updateTime(), 1000);
  }

  bindEvents() {
    const form = document.getElementById('promptForm');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.sendMessage();
      });
    }

    const connectBtn = document.getElementById('connectBtn');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    if (connectBtn) {
      connectBtn.addEventListener('click', () => {
        if (this.isConnected) {
          this.disconnect();
        } else {
          this.connect();
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        this.clearMessages();
      });
    }

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        this.connect();
      });
    }

    const fabToggle = document.getElementById('fabToggle');
    if (fabToggle) {
      fabToggle.addEventListener('click', () => {
        this.toggleCompactView();
      });
    }
  }

  setupAgentChips() {
    const agentChips = document.querySelectorAll('.agent-chip');
    agentChips.forEach(chip => {
       const checkbox = chip.querySelector('.agent-checkbox');
      if (checkbox) {
         // Set initial state for coordinator
         if (checkbox.id === 'agent-coordinator' && checkbox.checked) {
           chip.classList.add('active');
         }
         
        checkbox.addEventListener('change', (e) => {
           const agentName = e.target.id.replace('agent-', '');
          if (e.target.checked) {
             this.selectedAgents.add(agentName);
            chip.classList.add('active');
          } else {
             this.selectedAgents.delete(agentName);
            chip.classList.remove('active');
          }
           console.log('Selected agents:', Array.from(this.selectedAgents));
         });
         
         // Also handle click on the chip itself
         chip.addEventListener('click', (e) => {
           if (e.target === checkbox) return; // Don't double-handle checkbox clicks
           checkbox.checked = !checkbox.checked;
           checkbox.dispatchEvent(new Event('change'));
         });
       }
    });
  }

  setupToolButtons() {
    const toolButtons = {
      'btnAnalyze': 'Analyze the current codebase for issues and improvements',
      'btnTest': 'Run comprehensive tests on the project',
      'btnBeautify': 'Apply beautification and formatting to the codebase',
      'btnScreenshot': 'Take screenshots of the current application state'
    };

    Object.entries(toolButtons).forEach(([id, prompt]) => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.addEventListener('click', () => {
          this.sendToolRequest(prompt);
        });
      }
    });
  }

  updateTime() {
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
      timeElement.textContent = new Date().toLocaleTimeString();
    }
  }

  async sendMessage() {
    const input = document.getElementById('promptInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;

    const userMessage = {
      type: 'user',
      content: message,
      timestamp: new Date(),
      agent: 'User',
      phase: 'PROMPT'
    };
    
    this.addMessage(userMessage);
    this.addToOutput(userMessage);

    input.value = '';

    try {
      // Determine which agents are relevant for this prompt
      const relevantAgents = this.getRelevantAgents(message);
      
      // Show coordinator is analyzing
      const analysisMessage = {
        type: 'agent',
        content: `🔍 **Coordinator**: Analyzing request and consulting with ${relevantAgents.length} specialized agent${relevantAgents.length > 1 ? 's' : ''}: ${relevantAgents.join(', ')}`,
        timestamp: new Date(),
        agent: 'Coordinator',
        phase: 'ANALYSIS'
      };
      this.addToOutput(analysisMessage);
      
      // Collect responses from each agent
      const agentResponses = [];
      
      for (const agent of relevantAgents) {
        try {
          const agentData = await window.LCC_API.handleAPIRequest('prompt', {
            prompt: message,
            agents: [agent]
          });
          
          const agentResponse = {
            type: 'agent',
            content: agentData.response,
            timestamp: new Date(),
            agent: agent,
            phase: 'RESPONSE'
          };
          
          agentResponses.push(agentResponse);
          this.addToOutput(agentResponse);
          
        } catch (error) {
          const errorResponse = {
            type: 'agent',
            content: `❌ **${agent}**: Error - ${error.message}`,
            timestamp: new Date(),
            agent: agent,
            phase: 'ERROR'
          };
          agentResponses.push(errorResponse);
          this.addToOutput(errorResponse);
        }
      }
      
      // Generate final coordinated response
      const finalResponse = this.synthesizeResponses(message, agentResponses);
      
      const coordinatorMessage = {
        type: 'agent',
        content: finalResponse,
        timestamp: new Date(),
        agent: 'Coordinator',
        phase: 'FINAL_ANSWER'
      };
      
      this.addMessage(coordinatorMessage);
      this.addToOutput(coordinatorMessage);
      
    } catch (error) {
      const errorMessage = {
        type: 'system',
        content: `Connection error: ${error.message}`,
        timestamp: new Date(),
        agent: 'System',
        phase: 'ERROR'
      };
      this.addMessage(errorMessage);
      this.addToOutput(errorMessage);
    }
  }

  async sendToolRequest(prompt) {
    const toolMessage = {
      type: 'system',
      content: `Tool request: ${prompt}`,
      timestamp: new Date(),
      agent: 'System',
      phase: 'INFO'
    };
    
    this.addMessage(toolMessage);
    this.addToOutput(toolMessage);

    try {
      const response = await fetch(`${this.sseBase}/prompt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: prompt,
          agents: Array.from(this.selectedAgents)
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      const errorMessage = {
        type: 'system',
        content: `Tool error: ${error.message}`,
        timestamp: new Date(),
        agent: 'System',
        phase: 'ERROR'
      };
      this.addMessage(errorMessage);
      this.addToOutput(errorMessage);
    }
  }

  addMessage(message) {
      // Create a more robust message ID that includes content hash
      const contentHash = this.hashString(message.content);
      const messageId = `${message.agent}-${message.phase}-${contentHash}-${message.timestamp.getTime()}`;
      
      if (this.processedMessages.has(messageId)) {
        console.log('Duplicate message detected, skipping:', message.content.substring(0, 50));
        return;
      }
      
      // Check for recent duplicates with same content and agent (more strict)
      const isDuplicate = this.messages.some(existing => {
        const timeDiff = Math.abs(existing.timestamp.getTime() - message.timestamp.getTime());
        return existing.content === message.content && 
               existing.agent === message.agent && 
               existing.phase === message.phase &&
               timeDiff < 10000; // Increased time window for better filtering
      });
      
      if (isDuplicate) {
        console.log('Duplicate message detected (time-based), skipping:', message.content.substring(0, 50));
        return;
      }
      
      // Additional check: if we have too many similar messages in a short time, skip
      const recentSimilarMessages = this.messages.filter(existing => {
        const timeDiff = Math.abs(existing.timestamp.getTime() - message.timestamp.getTime());
        return timeDiff < 5000 && existing.agent === message.agent;
      });
      
      if (recentSimilarMessages.length > 5) {
        console.log('Too many recent messages from same agent, skipping:', message.content.substring(0, 50));
        return;
      }
      
      this.processedMessages.add(messageId);
      
      // Clean up old processed messages more aggressively
      if (this.processedMessages.size > 500) {
        const keys = Array.from(this.processedMessages.keys());
        keys.slice(0, 100).forEach(key => this.processedMessages.delete(key));
      }
      
    this.messages.push(message);
      
      // Only render if it's a final answer or user message
      if (message.phase === 'ANSWER' || message.phase === 'FINAL' || message.phase === 'FINAL_ANSWER' || message.type === 'user') {
    this.renderMessage(message);
      }
    }

   // Simple hash function for content
   hashString(str) {
     let hash = 0;
     if (str.length === 0) return hash;
     for (let i = 0; i < str.length; i++) {
       const char = str.charCodeAt(i);
       hash = ((hash << 5) - hash) + char;
       hash = hash & hash; // Convert to 32bit integer
     }
     return Math.abs(hash);
  }

  renderMessage(message) {
    const chatArea = document.getElementById('chatArea');
    if (!chatArea) return;
    
    const bubble = document.createElement('div');
    bubble.className = `bubble ${message.type}`;
    
    const time = message.timestamp.toLocaleTimeString();
    const agentIcon = this.getAgentIcon(message.agent);
    
    bubble.innerHTML = `
      <div class="bubble-meta">
        <div class="avatar ${message.type}">${agentIcon}</div>
        <span>${message.agent}</span>
        <span class="phase-tag">${message.phase || 'INFO'}</span>
        <span>${time}</span>
      </div>
      <div class="bubble-content">
        ${this.formatMessageContent(message.content)}
      </div>
    `;
    
    chatArea.appendChild(bubble);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  getAgentIcon(agent) {
    const icons = {
      'User': '👤',
      'Coordinator': '🎯',
      'Test Runner': '🧪',
      'Beautifier': '🎨',
      'Fixer': '🔧',
       'Screenshot': '📸',
       'LLaVA': '👁️',
       'Project Coordinator': '📋',
       'Prompt Wave': '🌊',
       'Discussion System': '💬',
       'PDF Generator': '📄',
       'Babylon Game': '🎮',
       'JS2D Game': '🎯',
       'ThreeJS Game': '🎲',
      'System': '⚙️'
    };
    return icons[agent] || '🤖';
  }

  formatMessageContent(content) {
    content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
    content = content.replace(/\n/g, '<br>');
    return content;
  }

  clearMessages() {
    this.messages = [];
    this.processedMessages.clear();
    
    const chatArea = document.getElementById('chatArea');
    if (chatArea) {
    chatArea.innerHTML = `
      <div class="bubble system">
        <div class="bubble-meta">
          <div class="avatar system">⚙️</div>
          <span>System</span>
          <span class="phase-tag">INFO</span>
          <span>${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="bubble-content">
          Messages cleared. Ready for new conversation.
        </div>
      </div>
    `;
    }
    
    const codeOutput = document.getElementById('codeOutput');
    if (codeOutput) {
      codeOutput.innerHTML = `
        <div class="output-placeholder">
          Agent discussions will appear here...
        </div>
      `;
    }
  }

  connect() {
     // Prevent multiple connection attempts
     if (this.connecting) {
       console.log('Connection already in progress, skipping...');
       return;
     }
     
     this.connecting = true;
     
           // For local development, use real SSE connection
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Local development detected, using real SSE connection...');
      } else if (window.location.hostname === 'planeszwalker.github.io') {
        // Silent GitHub Pages mode - no console logs for production
        setTimeout(() => {
          this.isConnected = true;
          this.connecting = false;
          this.updateConnectionStatus('connected', 'Connected');
          this.retryCount = 0;
        }, 1000);
        return;
      }
     
     // Close existing connection if any
     if (this.sse && this.sse.readyState !== EventSource.CLOSED) {
       console.log('SSE connection already exists, closing first...');
      this.sse.close();
       this.sse = null;
    }

    try {
       console.log('Connecting to SSE stream...');
      this.sse = new EventSource(`${this.sseBase}/logs/stream?file=latest.log`);
      
      this.sse.onopen = () => {
         console.log('SSE connection opened successfully');
        this.isConnected = true;
         this.connecting = false;
        this.updateConnectionStatus('connected', 'Connected');
         this.retryCount = 0;
      };
      
             this.sse.onmessage = (event) => {
         try {
           if (!event.data || event.data.trim() === '') {
             return;
           }
           
           const trimmedData = event.data.trim();
           if (!trimmedData.startsWith('{') || !trimmedData.endsWith('}')) {
             console.log('Incomplete JSON data received, skipping:', trimmedData.substring(0, 50));
             return;
           }
           
           const data = JSON.parse(trimmedData);
           if (data && data.text) {
             const timestamp = data.timestamp || Date.now();
             
             // Create a more robust message ID using content hash
             const contentHash = this.hashString(data.text);
             const messageId = `${data.agent || 'Agent'}-${data.phase || 'INFO'}-${contentHash}-${timestamp}`;
             
             if (this.processedMessages.has(messageId)) {
               console.log('Duplicate SSE message detected, skipping:', data.text.substring(0, 50));
               return;
             }
             
             // Check for recent duplicates with same content (more strict)
             const currentTime = Date.now();
             const isRecentDuplicate = Array.from(this.processedMessages).some(existingId => {
               const parts = existingId.split('-');
               const existingHash = parts[2];
               const existingTimestamp = parseInt(parts[parts.length - 1]);
               
               return existingHash === contentHash.toString() && 
                      Math.abs(currentTime - existingTimestamp) < 5000; // Increased time window
             });
             
             if (isRecentDuplicate) {
               console.log('Recent duplicate SSE message detected, skipping:', data.text.substring(0, 50));
               return;
             }
             
             // Additional check: limit messages per agent per time window
             const recentAgentMessages = this.messages.filter(msg => {
               const timeDiff = Math.abs(msg.timestamp.getTime() - timestamp);
               return msg.agent === (data.agent || 'Agent') && timeDiff < 10000;
             });
             
             if (recentAgentMessages.length > 10) {
               console.log('Too many recent messages from agent, skipping:', data.text.substring(0, 50));
               return;
             }
             
             this.processedMessages.add(messageId);
             
             // Clean up old processed messages more aggressively
             if (this.processedMessages.size > 500) {
               const keys = Array.from(this.processedMessages.keys());
               keys.slice(0, 100).forEach(key => this.processedMessages.delete(key));
             }
             
             // Create message object
             const messageObj = {
               type: data.role === 'user' ? 'user' : 'agent',
               content: data.text,
               timestamp: new Date(timestamp),
               agent: data.agent || 'Agent',
               phase: data.phase || 'INFO'
             };
             
             // Only show final answers in chat, show all discussions in output
             if (data.phase === 'ANSWER' || data.phase === 'FINAL') {
               this.addMessage(messageObj);
             }
             
             // Always add to output section for full discussion
             this.addToOutput(messageObj);
           }
         } catch (error) {
           if (event.data && event.data.trim() !== '') {
             console.error('Error parsing SSE data:', error, 'Raw data:', event.data.substring(0, 100));
           }
         }
       };
      
             this.sse.onerror = (error) => {
         console.error('SSE connection error:', error);
        this.isConnected = false;
         this.connecting = false;
        this.updateConnectionStatus('disconnected', 'Connection Error');
         
         if (!this.retryCount) this.retryCount = 0;
         this.retryCount++;
         
         if (this.retryCount <= 3) {
           const delay = Math.min(1000 * Math.pow(2, this.retryCount - 1), 10000);
           console.log(`SSE connection failed, retrying in ${delay}ms (attempt ${this.retryCount}/3)...`);
           
           setTimeout(() => {
             if (this.retryCount <= 3) {
               this.connect();
             }
           }, delay);
         } else {
           console.log('SSE connection failed after 3 retries, giving up');
           this.retryCount = 0; // Reset for manual retry
         }
      };
      
    } catch (error) {
      console.error('Failed to create SSE connection:', error);
      this.isConnected = false;
      this.updateConnectionStatus('disconnected', 'Connection Failed');
    }
  }

  disconnect() {
    if (this.sse) {
      this.sse.close();
      this.sse = null;
    }
    this.isConnected = false;
    this.updateConnectionStatus('disconnected', 'Disconnected');
  }

  updateConnectionStatus(type, text) {
    const connectBtn = document.getElementById('connectBtn');
    
    if (connectBtn) {
      if (type === 'connected') {
        connectBtn.innerHTML = '<i class="fas fa-unplug"></i> Disconnect';
        connectBtn.classList.remove('btn-primary');
        connectBtn.classList.add('btn-secondary');
         this.isConnected = true;
      } else {
        connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
        connectBtn.classList.remove('btn-secondary');
        connectBtn.classList.add('btn-primary');
         this.isConnected = false;
       }
     }
   }

     addToOutput(message) {
     const codeOutput = document.getElementById('codeOutput');
     if (!codeOutput) return;
     
     const placeholder = codeOutput.querySelector('.output-placeholder');
     if (placeholder) {
       placeholder.remove();
     }
     
     const outputItem = document.createElement('div');
     outputItem.className = 'output-item';
     
     const time = message.timestamp.toLocaleTimeString();
     const agentIcon = this.getAgentIcon(message.agent);
     
     outputItem.innerHTML = `
       <div class="output-meta">
         <span class="output-agent">${agentIcon} ${message.agent}</span>
         <span class="output-phase">${message.phase}</span>
         <span class="output-time">${time}</span>
       </div>
       <div class="output-content">
         ${this.formatMessageContent(message.content)}
       </div>
     `;
     
     codeOutput.appendChild(outputItem);
     codeOutput.scrollTop = codeOutput.scrollHeight;
     
     // Limit output items to prevent overwhelming the interface
     const outputItems = codeOutput.querySelectorAll('.output-item');
     if (outputItems.length > 30) {
       // Remove oldest items in batches
       const itemsToRemove = outputItems.length - 20;
       for (let i = 0; i < itemsToRemove; i++) {
         if (outputItems[i]) {
           outputItems[i].remove();
         }
       }
    }
  }

  toggleCompactView() {
     document.body.classList.toggle('compact');
    
    const fabToggle = document.getElementById('fabToggle');
    if (fabToggle) {
      const icon = fabToggle.querySelector('i');
       if (document.body.classList.contains('compact')) {
        icon.className = 'fas fa-expand';
         console.log('Compact view enabled');
      } else {
        icon.className = 'fas fa-compress';
         console.log('Compact view disabled');
       }
     }
   }

  // Coordinator workflow helper methods
  getRelevantAgents(prompt) {
    const p = prompt.toLowerCase();
    const relevantAgents = new Set();
    
    // Always include coordinator
    relevantAgents.add('coordinator');
    
    // Image analysis
    if (/\b(image|screenshot|photo|picture|capture)\b/i.test(p)) {
      relevantAgents.add('llava-agent');
    }

    // Testing
    if (/(run|launch|start)\s+(all\s+)?tests?|test\s*suite|lighthouse|axe|accessibilit|perf|performance/.test(p)) {
      relevantAgents.add('test-runner');
    }

    // Styling and theming
    if (/dark|theme|style|css|brace|sanitize|validation|selector|duplicate/.test(p)) {
      relevantAgents.add('website-beautifier');
      relevantAgents.add('fixer-agent');
    }

    // Game development
    if (/babylon|3d|unified/.test(p)) {
      relevantAgents.add('babylon-game-finisher');
    }
    if (/three\.js|threejs|three\b/.test(p)) {
      relevantAgents.add('threejs-game-finisher');
    }
    if (/2d|canvas|classique/.test(p)) {
      relevantAgents.add('js2d-game-finisher');
    }

    // Screenshot
    if (/screenshot|capture|photo|image/.test(p)) {
      relevantAgents.add('screenshot-agent');
    }

    // General analysis and fixing
    if (/analyze|fix|problem|issue|bug|error/.test(p)) {
      relevantAgents.add('fixer-agent');
    }

    // Default to coordinator and fixer if no specific agents
    if (relevantAgents.size === 1) {
      relevantAgents.add('fixer-agent');
    }
    
    return Array.from(relevantAgents);
  }

  synthesizeResponses(userPrompt, agentResponses) {
    if (agentResponses.length === 0) {
      return "❌ **Coordinator**: No agents were able to process your request.";
    }

    const validResponses = agentResponses.filter(response => response.phase !== 'ERROR');
    
    if (validResponses.length === 0) {
      return "❌ **Coordinator**: All agents encountered errors while processing your request.";
    }

    let synthesis = `🎯 **Coordinator's Response**\n\n`;
    synthesis += `**Question**: ${userPrompt}\n\n`;
    synthesis += `**Analysis**: I consulted with ${validResponses.length} specialized agent${validResponses.length > 1 ? 's' : ''}.\n\n`;

    validResponses.forEach((response) => {
      synthesis += `**${response.agent}**: ${response.content}\n\n`;
    });

    synthesis += `**🎯 Summary**: Based on the analysis from ${validResponses.length} agent${validResponses.length > 1 ? 's' : ''}, `;
    
    const allContent = validResponses.map(r => r.content).join(' ');
    if (allContent.includes('error') || allContent.includes('Error')) {
      synthesis += `there are some issues that need attention. Please review the detailed responses above.`;
    } else if (allContent.includes('success') || allContent.includes('Success') || allContent.includes('✅')) {
      synthesis += `the task has been completed successfully. All agents have provided their expertise.`;
    } else {
      synthesis += `I've gathered comprehensive information from the specialized agents. Please review their detailed responses above.`;
    }

    return synthesis;
  }
}

// Global variable for agents discussion instance
let agentsDiscussion;

document.addEventListener('DOMContentLoaded', () => {
   // Only log in development mode
   if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
     console.log('🚀 Initializing Agents Discussion Interface...');
   }
   try {
     agentsDiscussion = new AgentsDiscussion();
     if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
       console.log('✅ Agents Discussion Interface initialized successfully');
     }
   } catch (error) {
     console.error('❌ Error initializing Agents Discussion Interface:', error);
   }
});
</script>
</body>
</html>
